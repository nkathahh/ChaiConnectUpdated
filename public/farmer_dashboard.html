<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Farmer Dashboard — ChaiConnect</title>
  <link rel="stylesheet" href="/css/dashboards_style.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" />
</head>
<body>

  <!-- ===== TOP HEADER ===== -->
  <div class="top-header">
    <div class="left-section">
      <button class="menu-toggle" onclick="toggleSidebar()" aria-label="Toggle sidebar">
        <i class="fas fa-bars"></i>
      </button>
      <h2>ChaiConnect</h2>
    </div>
    <div class="right-icons">
      <a href="/alerts.html" class="alert-link" title="Alerts">
        <i class="fas fa-bell"></i>
        <span id="alertCount">0</span>
      </a>
      <a href="/notifications.html" class="alert-link" title="Notifications">
        <i class="fas fa-inbox"></i>
        <span id="notifCount">0</span>
      </a>
      <label class="theme-switch" title="Toggle dark mode">
        <input type="checkbox" id="themeToggle" />
        <span class="slider"></span>
      </label>
      <button class="logout-button" onclick="logout()">
        <i class="fas fa-sign-out-alt"></i> Logout
      </button>
    </div>
  </div>

  <!-- ===== SIDEBAR ===== -->
  <div class="sidebar" id="sidebar">
    <h3>Farmer Portal</h3>
    <ul>
      <li><a href="#" class="active"><i class="fas fa-house"></i> Home</a></li>
      <li><a href="/view_profile.html"><i class="fas fa-user-circle"></i> My Profile</a></li>
      <li><a href="/delivery_history.html"><i class="fas fa-truck"></i> Delivery History</a></li>
      <li><a href="/payment_summary.html"><i class="fas fa-coins"></i> Payment Summary</a></li>
      <li><a href="/extension_services.html"><i class="fas fa-calendar-check"></i> Extension Services</a></li>
      <li><a href="/farmer_complaint.html"><i class="fas fa-comment-dots"></i> Issue Complaint</a></li>
      <li><a href="/view_policies.html"><i class="fas fa-file-lines"></i> View Policies</a></li>
    </ul>
  </div>

  <!-- ===== MAIN CONTENT ===== -->
  <div class="main-content">

    <section id="overview">
      <h1 id="welcomeMessage">Welcome, Farmer</h1>
      <p>Access your deliveries, earnings, extension services, and tea updates.</p>
    </section>

    <!-- Stat Cards -->
    <div class="dashboard-cards">
      <div class="stat-card">
        <p><i class="fas fa-hourglass-half"></i> &nbsp;Pending Payment</p>
        <h2 id="pendingPayments">KES 0.00</h2>
      </div>
      <div class="stat-card">
        <p><i class="fas fa-calendar-week"></i> &nbsp;Monthly Earnings</p>
        <h2 id="monthEarnings">KES 0.00</h2>
      </div>
      <div class="stat-card">
        <p><i class="fas fa-circle-check"></i> &nbsp;Account Status</p>
        <h2 id="accountStatus">Loading…</h2>
      </div>
      <div class="stat-card">
        <p><i class="fas fa-person-digging"></i> &nbsp;My Extension Officer</p>
        <h2 id="myOfficerName">Not assigned</h2>
        <button id="viewOfficerBtn" class="btn-view-officer" onclick="openOfficerModal()" style="display:none;">
          <i class="fas fa-address-card"></i> View Contacts
        </button>
      </div>
    </div>

    <!-- Action Cards -->
    <div class="card-actions">
      <div class="card">
        <h3><i class="fas fa-truck"></i> Delivery History</h3>
        <p>View and download your complete delivery history with dates and weights.</p>
        <button onclick="location.href='/delivery_history.html'">View</button>
      </div>
      <div class="card">
        <h3><i class="fas fa-coins"></i> View Payments</h3>
        <p>See your earnings, current rates per kg, and full payment history.</p>
        <button onclick="location.href='/payment_summary.html'">Payments</button>
      </div>
      <div class="card">
        <h3><i class="fas fa-calendar-check"></i> Extension Visits</h3>
        <p>Book agronomist farm visits and check upcoming training sessions.</p>
        <button onclick="location.href='/extension_services.html'">Book</button>
      </div>
      <div class="card">
        <h3><i class="fas fa-comment-dots"></i> Submit Complaint</h3>
        <p>Raise a complaint, report an issue, or ask our support team a question.</p>
        <button onclick="location.href='/farmer_complaint.html'">Support</button>
      </div>
      <div class="card">
        <h3><i class="fas fa-book-open"></i> Training Materials</h3>
        <p>Browse all training resources and guides shared by extension officers.</p>
        <button onclick="location.href='/view_training_materials.html'">View</button>
      </div>
    </div>

  </div>

  <!-- ===== OFFICER MODAL ===== -->
  <div id="officerModal" class="modal">
    <div class="modal-content">
      <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:1rem;">
        <h3><i class="fas fa-person-digging" style="color:var(--green-bright);margin-right:.5rem;"></i>Extension Officer Details</h3>
        <button class="modal-close-btn" onclick="closeOfficerModal()">×</button>
      </div>
      <p><b>Name:</b> <span id="officerName">—</span></p>
      <p><b>Phone:</b> <span id="officerPhone">—</span></p>
      <p><b>Email:</b> <span id="officerEmail">—</span></p>
      <p><b>Region:</b> <span id="officerRegion">—</span></p>
      <p><b>Specialization:</b> <span id="officerSpec">—</span></p>
      <p><b>Assigned since:</b> <span id="officerSince">—</span></p>
    </div>
  </div>

  <div id="logoutToast" class="toast">
    <i class="fas fa-check-circle"></i> Logged out successfully
  </div>

  <script>
    function formatCurrency(amount) {
      return 'KES ' + parseFloat(amount || 0).toFixed(2).replace(/\d(?=(\d{3})+\.)/g, '$&,');
    }

    async function loadDashboardStats() {
      try {
        const res = await fetch('/api/farmer/payments/stats', { credentials: 'include' });
        const stats = await res.json();
        document.getElementById('monthEarnings').textContent   = formatCurrency(stats.month_earnings  || 0);
        document.getElementById('pendingPayments').textContent = formatCurrency(stats.pending_amount  || 0);
      } catch (e) { console.error('Stats error:', e); }
    }

    let officerCache = null;

    async function loadMyExtensionOfficer() {
      try {
        const res = await fetch('/api/farmer/my-extension-officer', { credentials: 'include' });
        const data = await res.json();
        const nameEl = document.getElementById('myOfficerName');
        const btn    = document.getElementById('viewOfficerBtn');
        if (!data.success || !data.assigned || !data.officer) {
          nameEl.textContent = 'Not assigned';
          btn.style.display  = 'none';
          return;
        }
        officerCache = data.officer;
        nameEl.textContent = data.officer.officer_name || 'Assigned';
        btn.style.display  = 'inline-block';
      } catch (e) { console.error('Officer error:', e); }
    }

    function openOfficerModal() {
      if (!officerCache) return;
      document.getElementById('officerName').textContent   = officerCache.officer_name   || '—';
      document.getElementById('officerPhone').textContent  = officerCache.officer_phone  || '—';
      document.getElementById('officerEmail').textContent  = officerCache.officer_email  || '—';
      document.getElementById('officerRegion').textContent = officerCache.region          || '—';
      document.getElementById('officerSpec').textContent   = officerCache.specialization  || '—';
      document.getElementById('officerSince').textContent  = officerCache.assigned_since  || '—';
      document.getElementById('officerModal').style.display = 'flex';
    }

    function closeOfficerModal() {
      document.getElementById('officerModal').style.display = 'none';
    }

    document.addEventListener('click', e => {
      const modal = document.getElementById('officerModal');
      if (modal.style.display === 'flex' && e.target === modal) closeOfficerModal();
    });

    document.addEventListener('keydown', e => { if (e.key === 'Escape') closeOfficerModal(); });

    document.addEventListener('DOMContentLoaded', () => {
      fetch('/api/me')
        .then(res => res.json())
        .then(data => {
          document.getElementById('welcomeMessage').textContent = `Welcome, ${data.name}`;
          const farmerId = data.userId;
          fetch(`/api/farmer/${farmerId}/profile`)
            .then(r => r.json())
            .then(profile => {
              document.getElementById('accountStatus').textContent =
                profile.is_suspended ? 'Suspended' :
                profile.is_flagged   ? 'Under Review' : 'Active';
            });
          loadDashboardStats();
          loadMyExtensionOfficer();
        })
        .catch(() => {});

      fetch('/alerts/count')
        .then(r => r.json())
        .then(data => {
          const badge = document.getElementById('alertCount');
          if (data.count > 0) { badge.textContent = data.count; badge.style.display = 'inline-block'; }
        }).catch(() => {});

      fetch('/api/notifications/count')
        .then(r => r.json())
        .then(data => {
          if (!data.success) return;
          const badge = document.getElementById('notifCount');
          badge.textContent = data.count;
          badge.style.display = data.count > 0 ? 'inline-block' : 'none';
        }).catch(() => {});
    });

    function toggleSidebar() {
      document.getElementById('sidebar').classList.toggle('active');
    }

    function logout() {
      fetch('/logout', { method: 'POST' }).then(() => {
        document.getElementById('logoutToast').classList.add('show');
        setTimeout(() => window.location.href = '/', 1500);
      });
    }
  </script>

  <script src="logout.js"></script>
  <script src="/alertCount.js"></script>
  <script src="/darkLight.js"></script>
</body>
</html>