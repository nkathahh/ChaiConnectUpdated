<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Farmer Dashboard | chaiConnect</title>
  <link rel="stylesheet" href="/css/dashboards_style.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
  <style>
    /* ===== Modal Styling (Farmer Dashboard) ===== */

    .modal {
      position: fixed;
      inset: 0;
      display: none;
      align-items: center;
      justify-content: center;
      background: rgba(15, 23, 42, 0.6);
      /* dark overlay */
      z-index: 9999;
      padding: 16px;
    }

    .modal-content {
      background: #ffffff;
      width: 100%;
      max-width: 520px;
      border-radius: 16px;
      padding: 20px;
      box-shadow: 0 20px 40px rgba(0, 0, 0, 0.15);
      animation: modalFade 0.25s ease;
    }

    .modal-content h3 {
      margin: 0;
      color: #0f172a;
    }

    .modal-content p {
      color: #334155;
      font-size: 14px;
    }

    .modal-content button {
      font-weight: 600;
    }

    @keyframes modalFade {
      from {
        opacity: 0;
        transform: translateY(15px);
      }

      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    /* Dark Mode Support */
    body.dark-mode .modal-content {
      background: #1e293b;
      color: #f1f5f9;
    }

    body.dark-mode .modal-content p {
      color: #cbd5e1;
    }

    /* ===== View Contacts Button (Stat Card Style) ===== */

    .btn-view-officer {
      margin-top: 10px;
      padding: 8px 14px;
      border-radius: 999px;
      border: none;
      background: linear-gradient(135deg, #059669, #047857);
      color: #ffffff;
      font-size: 13px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s ease;
      box-shadow: 0 4px 12px rgba(5, 150, 105, 0.25);
    }

    .btn-view-officer:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 18px rgba(5, 150, 105, 0.35);
    }

    .btn-view-officer:active {
      transform: translateY(0);
    }

    /* Dark mode support */
    body.dark-mode .btn-view-officer {
      background: linear-gradient(135deg, #10b981, #059669);
    }
  </style>
</head>

<body>
  <!-- Header Content -->
  <div class="top-header">
    <div class="left-section">
      <button class="menu-toggle" onclick="toggleSidebar()">
        <i class="fas fa-bars"></i>
      </button>
      <h2>chaiConnect</h2>
    </div>
    <div class="right-icons">
      <a href="/alerts.html" title="View Alerts" class="alert-link">
        <i class="fas fa-bell"></i>
        <span id="alertCount">0</span>
      </a>
      <a href="/notifications.html" class="alert-link" title="Notifications" style="position:relative;">
        <i class="fas fa-inbox"></i>
        <span id="notifCount" style="
    position:absolute; top:-6px; right:-10px;
    background:#ef4444; color:#fff;
    font-size:12px; font-weight:800;
    border-radius:999px; padding:2px 7px;
    display:none;
  ">0</span>
      </a>


      <label class="theme-switch">
        <input type="checkbox" id="themeToggle">
        <span class="slider"></span>
      </label>
      <button class="logout-button" onclick="logout()">Logout</button>
    </div>
  </div>

  <!-- Sidebar Content -->
  <div class="sidebar">
    <h3>Farmer Dashboard</h3>
    <ul>
      <li><a href="#" class="active">Home</a></li>
      <li><a href="/view_profile.html">My Profile</a></li>
      <li><a href="/delivery_history.html">Delivery History</a></li>
      <li><a href="/payment_summary.html">Payment Summary</a></li>
      <li><a href="/extension_services.html">Extension Services</a></li>
      <li><a href="/farmer_complaint.html">Issue Complaint</a></li>
      <li><a href="/view_policies.html">View uploaded policies</a></li>
    </ul>
  </div>

  <!-- Main Content -->
  <div class="main-content">
    <section id="overview">
      <h1 id="welcomeMessage">Welcome, Farmer</h1>
      <p>Access your account, deliveries, earnings, and tea updates.</p>
    </section>

    <div class="dashboard-cards">
      <div class="stat-card">
        <p>Pending Payment</p>
        <h2 id="pendingPayments">KES 0.00</h2>
      </div>
      <div class="stat-card">
        <p>Monthly Earnings</p>
        <h2 id="monthEarnings">KES 0.00</h2>
      </div>
      <div class="stat-card">
        <p>Account Status</p>
        <h2 id="accountStatus">Loading...</h2>
      </div>
      <div class="stat-card">
        <p>My Extension Officer</p>
        <h2 id="myOfficerName">Not assigned</h2>
        <button id="viewOfficerBtn" class="btn-view-officer" onclick="openOfficerModal()" style="display:none;">
          View Contacts
        </button>

      </div>

    </div>

    <div class="card-actions">
      <div class="card">
        <h3>Delivery History</h3>
        <p>View and download your full delivery history.</p>
        <button onclick="location.href='/delivery_history.html'">View</button>
      </div>
      <div class="card">
        <h3>View Payments</h3>
        <p>See earnings, rates per kg, and past payments.</p>
        <button onclick="location.href='/payment_summary.html'">Payments</button>
      </div>
      <div class="card">
        <h3>Extension Visits</h3>
        <p>Book agronomist visits and upcoming trainings.</p>
        <button onclick="location.href='/extension_services.html'">Book</button>
      </div>
      <div class="card">
        <h3>Submit Complaint</h3>
        <p>Raise complaints or ask questions.</p>
        <button onclick="location.href='farmer_complaint.html'">Support</button>
      </div>
      <div class="card">
        <h3>View Training Materials</h3>
        <p>Browse all training resources shared by extension officers.</p>
        <button onclick="location.href='/view_training_materials.html'">View</button>
      </div>

    </div>
  </div>


  <div id="officerModal" class="modal" style="display:none;">
    <div class="modal-content" style="max-width:520px;">
      <div style="display:flex; justify-content:space-between; align-items:center;">
        <h3 style="margin:0;">Extension Officer Details</h3>
        <button onclick="closeOfficerModal()"
          style="border:none;background:transparent;font-size:22px;cursor:pointer;">×</button>
      </div>

      <div style="margin-top:12px;">
        <p style="margin:8px 0;"><b>Name:</b> <span id="officerName"></span></p>
        <p style="margin:8px 0;"><b>Phone:</b> <span id="officerPhone"></span></p>
        <p style="margin:8px 0;"><b>Email:</b> <span id="officerEmail"></span></p>
        <p style="margin:8px 0;"><b>Region:</b> <span id="officerRegion"></span></p>
        <p style="margin:8px 0;"><b>Specialization:</b> <span id="officerSpec"></span></p>
        <p style="margin:8px 0;"><b>Assigned since:</b> <span id="officerSince"></span></p>
      </div>
    </div>
  </div>


  <div id="logoutToast" class="toast">✅ Logged out successfully</div>

  <script>
    function formatCurrency(amount) {
      return 'KES ' + parseFloat(amount).toFixed(2).replace(/\d(?=(\d{3})+\.)/g, '$&,');
    }

    async function loadDashboardStats() {
      try {
        const response = await fetch('/api/farmer/payments/stats', {
          credentials: 'include'
        });
        const stats = await response.json();

        document.getElementById('monthEarnings').textContent = formatCurrency(stats.month_earnings || 0);
        document.getElementById('pendingPayments').textContent = formatCurrency(stats.pending_amount || 0);
      } catch (error) {
        console.error('Error loading dashboard stats:', error);
      }
    }

    document.addEventListener('DOMContentLoaded', () => {
      fetch('/api/me')
        .then(res => res.json())
        .then(data => {
          document.getElementById('welcomeMessage').textContent = `Welcome, ${data.name}`;
          const farmerId = data.userId;

          fetch(`/api/farmer/${farmerId}/profile`)
            .then(res => res.json())
            .then(profile => {
              if (profile.is_suspended) {
                document.getElementById('accountStatus').textContent = 'Suspended';
              } else if (profile.is_flagged) {
                document.getElementById('accountStatus').textContent = 'Under Review';
              } else {
                document.getElementById('accountStatus').textContent = 'Active';
              }
            });

          loadDashboardStats();
          loadMyExtensionOfficer();
        });

      fetch('/alerts/count')
        .then(res => res.json())
        .then(data => {
          const alertCount = document.getElementById('alertCount');
          if (data.count > 0) {
            alertCount.textContent = data.count;
            alertCount.style.display = 'flex';
          }
        });
      fetch('/api/notifications/count')
        .then(res => res.json())
        .then(data => {
          if (!data.success) return;
          const badge = document.getElementById('notifCount');
          badge.textContent = data.count;
          badge.style.display = data.count > 0 ? 'flex' : 'none';
        })
        .catch(() => { });


      loadFarmerVisitData();
    });

    function loadFarmerVisitData() {
      fetch('/api/my-visits')
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            renderFarmerVisits(data.visits);
          }
        });

      fetch('/api/training-sessions')
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            renderTrainingSessions(data.sessions);
          }
        });
    }

    function renderFarmerVisits(visits) {
      const container = document.getElementById('visitsContainer');
      if (!container) return;

      if (visits.length === 0) {
        container.innerHTML = '<p>No visits scheduled yet.</p>';
        return;
      }

      let html = '<div class="list-group">';
      visits.forEach(visit => {
        const date = visit.scheduled_date ? new Date(visit.scheduled_date) : new Date(visit.preferred_date);
        const statusClass = `status-${visit.status}`;

        html += `
          <div class="list-group-item">
            <div class="d-flex justify-content-between">
              <h5>${visit.purpose}</h5>
              <span class="badge ${statusClass}">${visit.status.charAt(0).toUpperCase() + visit.status.slice(1)}</span>
            </div>
            <p><i class="far fa-calendar"></i> ${date.toLocaleDateString()} 
               <i class="far fa-clock"></i> ${date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}</p>
            ${visit.notes ? `<p><i class="fas fa-sticky-note"></i> ${visit.notes}</p>` : ''}
            ${visit.officer_name ? `
            <p><i class="fas fa-user-tie"></i> Officer: ${visit.officer_name} 
               ${visit.officer_phone ? `(<i class="fas fa-phone"></i> ${visit.officer_phone})` : ''}
            </p>` : ''}
          </div>
        `;
      });

      html += '</div>';
      container.innerHTML = html;
    }

    function logout() {
      fetch('/logout', { method: 'POST' })
        .then(() => {
          const toast = document.getElementById('logoutToast');
          toast.classList.add('show');
          setTimeout(() => {
            window.location.href = '/';
          }, 1500);
        });
    }
    function toggleSidebar() {
      document.querySelector('.sidebar').classList.toggle('active');
    }

    let officerCache = null;

    async function loadMyExtensionOfficer() {
      try {
        const res = await fetch('/api/farmer/my-extension-officer', { credentials: 'include' });
        const data = await res.json();

        const nameEl = document.getElementById('myOfficerName');
        const btn = document.getElementById('viewOfficerBtn');

        if (!data.success || !data.assigned || !data.officer) {
          nameEl.textContent = 'Not assigned';
          btn.style.display = 'none';
          officerCache = null;
          return;
        }

        officerCache = data.officer;
        nameEl.textContent = data.officer.officer_name || 'Assigned';
        btn.style.display = 'inline-block';
      } catch (err) {
        console.error('Error loading assigned officer:', err);
      }
    }

    function openOfficerModal() {
      if (!officerCache) return;

      document.getElementById('officerName').textContent = officerCache.officer_name || '—';
      document.getElementById('officerPhone').textContent = officerCache.officer_phone || '—';
      document.getElementById('officerEmail').textContent = officerCache.officer_email || '—';
      document.getElementById('officerRegion').textContent = officerCache.region || '—';
      document.getElementById('officerSpec').textContent = officerCache.specialization || '—';
      document.getElementById('officerSince').textContent = officerCache.assigned_since || '—';

      document.getElementById('officerModal').style.display = 'flex';
    }

    function closeOfficerModal() {
      document.getElementById('officerModal').style.display = 'none';
    }

    // close modal on outside click
    document.addEventListener('click', (e) => {
      const modal = document.getElementById('officerModal');
      if (!modal) return;
      if (modal.style.display === 'block' && e.target === modal) closeOfficerModal();
    });

    // close modal on ESC
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') closeOfficerModal();
    });


  </script>

  <script src="logout.js"></script>
  <script src="/alertCount.js"></script>
  <script src="/darkLight.js"></script>
</body>

</html>