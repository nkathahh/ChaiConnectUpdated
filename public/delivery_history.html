<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Delivery History — ChaiConnect</title>
  <link rel="stylesheet" href="/css/farmer_dashboard_items.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />
</head>
<body>
  <script src="theme.js"></script>

  <div class="page-wrapper wide">

    <div class="page-header">
      <div class="page-header-left">
        <h1><i class="fas fa-truck"></i> My Delivery History</h1>
        <p>Full record of all your tea deliveries and payment statuses.</p>
      </div>
      <a href="/farmer_dashboard.html" class="btn-back-dashboard">
        <i class="fas fa-arrow-left"></i> Back to Dashboard
      </a>
    </div>

    <!-- Result count + export -->
    <div class="toolbar">
      <div class="search-box">
        <i class="fas fa-magnifying-glass"></i>
        <input type="text" id="searchInput" placeholder="Search by status, grade, center…" oninput="filterTable()" />
      </div>
      <button class="btn btn-outline btn-sm" onclick="downloadCSV()">
        <i class="fas fa-file-csv"></i> Export CSV
      </button>
    </div>

    <div class="section-card" style="padding:0; overflow:hidden;">
      <div class="table-wrapper">
        <table>
          <thead>
            <tr>
              <th>Delivery Date</th>
              <th>Status</th>
              <th>Est. Qty (kg)</th>
              <th>Actual Qty (kg)</th>
              <th>Collection Center</th>
              <th>Quality Grade</th>
              <th>Payment</th>
            </tr>
          </thead>
          <tbody id="deliveryTableBody">
            <tr class="loading-row">
              <td colspan="7">
                <span class="spinner"></span>&nbsp; Loading deliveries…
              </td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>

    <div style="display:flex; justify-content:space-between; align-items:center; margin-top:.5rem;">
      <span id="resultCount" style="font-size:.85rem; color:var(--text-light);">Showing 0 results</span>
    </div>

  </div>

  <!-- Cancel Modal -->
  <div id="cancelModal" class="modal-overlay">
    <div class="modal-box">
      <div class="modal-header">
        <h3><i class="fas fa-ban" style="color:var(--red);"></i> Cancel Delivery Request</h3>
        <button class="modal-close" onclick="closeModal()">×</button>
      </div>
      <p style="color:var(--text-mid);margin-bottom:1rem;">Are you sure you want to cancel this delivery request?</p>
      <div class="form-group">
        <label>Reason for cancellation (optional)</label>
        <textarea id="cancelReason" placeholder="Describe the reason…"></textarea>
      </div>
      <div class="btn-group right">
        <button class="btn btn-secondary" onclick="closeModal()">Close</button>
        <button class="btn btn-danger" onclick="confirmCancel()">Confirm Cancel</button>
      </div>
    </div>
  </div>

  <script>

    let allDeliveries = [];
    let currentRequestId = null;

    document.addEventListener('DOMContentLoaded', loadDeliveries);

    async function loadDeliveries() {
      try {
        const res = await fetch('/api/delivery-history', { credentials: 'include' });
        if (!res.ok) throw new Error(`Server returned ${res.status}`);
        allDeliveries = await res.json();
        allDeliveries.sort((a, b) => new Date(b.delivery_date) - new Date(a.delivery_date));
        renderTable(allDeliveries);
      } catch (err) {
        document.getElementById('deliveryTableBody').innerHTML = `
          <tr><td colspan="7" style="text-align:center;padding:2rem;color:var(--red);">
            <i class="fas fa-exclamation-circle"></i> ${err.message || 'Failed to load. Please try again.'}
          </td></tr>`;
      }
    }

    function statusBadge(status) {
      const map = { pending:'badge-pending', scheduled:'badge-scheduled', completed:'badge-completed', cancelled:'badge-cancelled' };
      return `<span class="badge ${map[status] || 'badge-pending'}">${status || '—'}</span>`;
    }

    function paymentBadge(ps) {
      return ps === 'paid'
        ? `<span class="badge badge-paid"><i class="fas fa-check-circle"></i> Paid</span>`
        : `<span class="badge badge-unpaid"><i class="fas fa-hourglass-half"></i> ${ps || 'Unpaid'}</span>`;
    }

    function renderTable(data) {
      const tbody = document.getElementById('deliveryTableBody');
      document.getElementById('resultCount').textContent = `Showing ${data.length} result${data.length !== 1 ? 's' : ''}`;

      if (!data.length) {
        tbody.innerHTML = `<tr><td colspan="7" style="text-align:center;padding:2.5rem;color:var(--text-light);">
          <i class="fas fa-info-circle"></i> No delivery records found.
        </td></tr>`;
        return;
      }

      tbody.innerHTML = data.map(d => `
        <tr>
          <td>${new Date(d.delivery_date).toLocaleDateString('en-KE')}</td>
          <td>${statusBadge(d.status)}</td>
          <td>${d.estimated_quantity ?? '—'} kg</td>
          <td>${d.quantity_kg ?? '—'} kg</td>
          <td>${d.collection_center || '—'}</td>
          <td>${d.quality_grade || '—'}</td>
          <td>${paymentBadge(d.payment_status)}</td>
        </tr>`).join('');
    }

    function filterTable() {
      const q = document.getElementById('searchInput').value.toLowerCase();
      const filtered = allDeliveries.filter(d =>
        (d.status || '').toLowerCase().includes(q) ||
        (d.quality_grade || '').toLowerCase().includes(q) ||
        (d.collection_center || '').toLowerCase().includes(q) ||
        (d.payment_status || '').toLowerCase().includes(q)
      );
      renderTable(filtered);
    }

    function downloadCSV() {
      if (!allDeliveries.length) { alert('No data to export.'); return; }
      const headers = ['Delivery Date','Status','Est. Qty (kg)','Actual Qty (kg)','Collection Center','Quality Grade','Payment Status'];
      const rows = allDeliveries.map(d => [
        new Date(d.delivery_date).toLocaleDateString(),
        d.status, d.estimated_quantity, d.quantity_kg,
        d.collection_center, d.quality_grade, d.payment_status
      ]);
      const csv = [headers, ...rows].map(r => r.join(',')).join('\n');
      const a = document.createElement('a');
      a.href = URL.createObjectURL(new Blob([csv], { type: 'text/csv' }));
      a.download = 'delivery_history.csv';
      a.click();
    }

    function closeModal() { document.getElementById('cancelModal').classList.remove('show'); }
    document.getElementById('cancelModal').addEventListener('click', e => { if (e.target === e.currentTarget) closeModal(); });
    document.addEventListener('keydown', e => { if (e.key === 'Escape') closeModal(); });
  </script>

</body>
</html>