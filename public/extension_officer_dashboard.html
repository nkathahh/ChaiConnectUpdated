<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Extension Officer Dashboard — ChaiConnect</title>
  <link rel="stylesheet" href="/css/dashboards_style.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />
</head>
<body>

  <!-- ===== TOP HEADER ===== -->
  <div class="top-header">
    <div class="left-section">
      <button class="menu-toggle" onclick="toggleSidebar()" aria-label="Toggle sidebar">
        <i class="fas fa-bars"></i>
      </button>
      <h2>ChaiConnect</h2>
    </div>
    <div class="right-icons">
      <a href="/alerts.html" class="alert-link" title="Alerts">
        <i class="fas fa-bell"></i>
        <span id="alertCount">0</span>
      </a>
      <a href="/notifications.html" class="alert-link" title="Notifications">
        <i class="fas fa-inbox"></i>
        <span id="notifCount">0</span>
      </a>
      <label class="theme-switch" title="Toggle dark mode">
        <input type="checkbox" id="themeToggle" />
        <span class="slider"></span>
      </label>
      <button class="logout-button" onclick="logout()">
        <i class="fas fa-sign-out-alt"></i> Logout
      </button>
    </div>
  </div>

  <!-- ===== SIDEBAR ===== -->
  <div class="sidebar" id="sidebar">
    <h3>Extension Officer</h3>
    <ul>
      <li><a href="#" class="active"><i class="fas fa-house"></i> Home</a></li>
      <li><a href="/view_profile.html"><i class="fas fa-user-circle"></i> My Profile</a></li>
      <li><a href="/assigned_farmers.html"><i class="fas fa-seedling"></i> Assigned Farmers</a></li>
      <li><a href="/upload_training.html"><i class="fas fa-upload"></i> Upload Training</a></li>
      <li><a href="/extension_complaints.html"><i class="fas fa-comment-dots"></i> Respond to Complaints</a></li>
      <li><a href="/all_visit_requests.html"><i class="fas fa-calendar-check"></i> Manage Visit Requests</a></li>
      <li><a href="/view_policies.html"><i class="fas fa-file-lines"></i> View Policies</a></li>
    </ul>
  </div>

  <!-- ===== MAIN CONTENT ===== -->
  <div class="main-content">

    <section id="overview">
      <h1 id="welcomeMessage">Welcome, <span id="officerName">Extension Officer</span></h1>
      <p>Manage your assigned farmers, schedule visits, and provide agricultural support.</p>
    </section>

    <!-- Stat Cards -->
    <div class="dashboard-cards">
      <div class="stat-card">
        <p><i class="fas fa-seedling"></i> &nbsp;Assigned Farmers</p>
        <h2 id="farmerCount">0</h2>
      </div>
      <div class="stat-card">
        <p><i class="fas fa-calendar-check"></i> &nbsp;Upcoming Visits</p>
        <h2 id="upcomingVisitsCount">0</h2>
      </div>
      <div class="stat-card">
        <p><i class="fas fa-book-open"></i> &nbsp;Training Materials</p>
        <h2 id="trainingMaterialsCount">0</h2>
      </div>
      <div class="stat-card">
        <p><i class="fas fa-comment-exclamation"></i> &nbsp;Open Complaints</p>
        <h2 id="openComplaintsCount">0</h2>
      </div>
    </div>

    <!-- Action Cards -->
    <div class="card-actions">
      <div class="card">
        <h3><i class="fas fa-seedling"></i> Assigned Farmers</h3>
        <p>View all farmers currently under your guidance and support assignment.</p>
        <button onclick="location.href='/assigned_farmers.html'">View</button>
      </div>
      <div class="card">
        <h3><i class="fas fa-upload"></i> Upload Training</h3>
        <p>Upload new training resources — files or text guides — for farmers to access.</p>
        <button onclick="location.href='/upload_training.html'">Upload</button>
      </div>
      <div class="card">
        <h3><i class="fas fa-comment-dots"></i> Respond to Complaints</h3>
        <p>Review and respond to concerns raised by your assigned farmers.</p>
        <button onclick="location.href='/extension_complaints.html'">Respond</button>
      </div>
      <div class="card">
        <h3><i class="fas fa-calendar-plus"></i> Visit Requests</h3>
        <p>View and schedule farm visit requests submitted by farmers in your region.</p>
        <button onclick="location.href='/all_visit_requests.html'">Manage</button>
      </div>
      <div class="card">
        <h3><i class="fas fa-book-open"></i> View Training Materials</h3>
        <p>Browse all training resources that have been shared across the platform.</p>
        <button onclick="location.href='/view_training_materials.html'">View</button>
      </div>
      <div class="card">
        <h3><i class="fas fa-pen-to-square"></i> Manage My Materials</h3>
        <p>Edit or delete only the training materials you personally uploaded.</p>
        <button onclick="location.href='/manage_training_materials.html'">Manage</button>
      </div>
    </div>

    <!-- Recently Assigned Farmers Table -->
    <div class="recent-farmers">
      <h3><i class="fas fa-users"></i> Recently Assigned Farmers</h3>
      <table class="farmers-table" id="recentFarmersTable">
        <thead>
          <tr>
            <th>Farmer Name</th>
            <th>Region</th>
            <th>Contact</th>
            <th>Assigned Since</th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <td colspan="4" style="text-align:center;color:var(--text-light);padding:1.5rem;">
              Loading farmers…
            </td>
          </tr>
        </tbody>
      </table>
      <a href="/assigned_farmers.html" class="view-all">View All Farmers →</a>
    </div>

  </div>

  <div id="logoutToast" class="toast">
    <i class="fas fa-check-circle"></i> Logged out successfully
  </div>

  <script>
    document.addEventListener('DOMContentLoaded', () => {

      // Welcome + assigned farmers
      fetch('/api/me')
        .then(res => res.json())
        .then(data => {
          document.getElementById('officerName').textContent = data.name || 'Extension Officer';

          fetch('/api/assigned-farmers', { credentials: 'include' })
            .then(res => res.json())
            .then(farmers => {
              document.getElementById('farmerCount').textContent = farmers.length;
              const tbody = document.querySelector('#recentFarmersTable tbody');
              const recent = farmers.slice(0, 5);
              if (recent.length === 0) {
                tbody.innerHTML = `<tr><td colspan="4" style="text-align:center;color:var(--text-light);padding:1.5rem;">No farmers assigned yet</td></tr>`;
              } else {
                tbody.innerHTML = recent.map(f => `
                  <tr>
                    <td>${f.name     || '—'}</td>
                    <td>${f.location || '—'}</td>
                    <td>${f.phone    || '—'}</td>
                    <td>—</td>
                  </tr>`).join('');
              }
            })
            .catch(() => { document.getElementById('farmerCount').textContent = '0'; });
        })
        .catch(() => {});

      // Complaints count
      fetch('/api/extension/complaints')
        .then(res => res.json())
        .then(data => {
          if (data.success) {
            document.getElementById('openComplaintsCount').textContent =
              data.complaints.filter(c => c.status === 'open').length;
          }
        }).catch(() => {});

      // Upcoming visits
      fetch('/api/officer/visits?status=scheduled', { credentials: 'include' })
        .then(res => res.json())
        .then(data => {
          if (data.success) {
            document.getElementById('upcomingVisitsCount').textContent = (data.visits || []).length;
          }
        }).catch(() => {});

      // Training materials count
      fetch('/api/training-materials/count')
        .then(res => res.json())
        .then(data => {
          if (data.success) document.getElementById('trainingMaterialsCount').textContent = data.count;
        }).catch(() => {});

      // Alert count
      fetch('/alerts/count')
        .then(res => res.json())
        .then(data => {
          const badge = document.getElementById('alertCount');
          if (data.count > 0) { badge.textContent = data.count; badge.style.display = 'inline-block'; }
        }).catch(() => {});

      // Notifications count
      fetch('/api/notifications/count')
        .then(res => res.json())
        .then(data => {
          if (!data.success) return;
          const badge = document.getElementById('notifCount');
          badge.textContent = data.count;
          badge.style.display = data.count > 0 ? 'inline-block' : 'none';
        }).catch(() => {});

      // Visit requests on load
      loadVisitRequests();
    });

    // ---- Visit Requests ----
    function loadVisitRequests() {
      fetch('/api/visit-requests')
        .then(res => res.json())
        .then(data => {
          if (data.success) {
            const upcoming = data.requests.filter(r => r.status === 'scheduled').length;
            document.getElementById('upcomingVisitsCount').textContent = upcoming;
          }
        }).catch(() => {});
    }

    function showToast(message, type = 'success') {
      const toast = document.createElement('div');
      toast.className = 'toast';
      toast.innerHTML = `<i class="fas fa-${type === 'success' ? 'check-circle' : 'exclamation-circle'}"></i> <span>${message}</span>`;
      document.body.appendChild(toast);
      setTimeout(() => toast.classList.add('show'), 10);
      setTimeout(() => { toast.classList.remove('show'); setTimeout(() => toast.remove(), 300); }, 3000);
    }

    function toggleSidebar() {
      document.getElementById('sidebar').classList.toggle('active');
    }

    function logout() {
      fetch('/logout', { method: 'POST' }).then(() => {
        document.getElementById('logoutToast').classList.add('show');
        setTimeout(() => window.location.href = '/', 1500);
      });
    }
  </script>

  <script src="logout.js"></script>
  <script src="/alertCount.js"></script>
  <script src="/darkLight.js"></script>
</body>
</html>